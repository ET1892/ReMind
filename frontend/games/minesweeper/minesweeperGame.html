<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minesweeper</title>
<style>
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    color: #9c9999;
    text-align: center;
  }

  #game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #stats {
    display: flex;
    justify-content: center;
    margin-bottom: 16px;
    font-size: 30px; 
  }

  #timer {
    font-weight: bold;  
  }

  #grid {
    border-collapse: collapse;
    margin: 0;
  }

  #grid tr td {
    border: 2px solid rgb(64, 63, 63);
    background: #dfdfdf;
    width: 40px;
    height: 40px;
    text-align: center;
    font-size: 18px;
    color: rgba(255, 255, 255, 0.836);
  }

  #grid tr td.clicked {
    background: #737373;
  }

  #grid tr td.mine {
    background: #FF0000;
  }

  button {
    margin-top: 12px;
    padding: 12px 24px;
    font-size: 1.2rem;
    cursor: pointer;
    background-color: #6d6c6c;
    color: #ffffff;
    border: none;
    border-radius: 8px;
    
  }

  button:hover {
    background-color: #555555;
  }

  @media (max-width: 768px) 
  {
    #grid tr td {
      width: 30px;
      height: 30px;
    }

    button {
      padding: 8px 16px;
      font-size: 1.1 rem;
    }
  }

  @media (max-width: 300px) 
  {
    #grid tr td {
      width: 25px;
      height: 25px;
    }

    button {
      padding: 6px 12px;
      font-size: 1 rem;


    }
  }
</style>
</head>
<body>

<div id="game-container">
  <div id="stats">
    <div>Time: <span id="timer">0</span>s</div>
  </div>
  <table id="grid"></table>
  <button onclick="generateGrid();">Reset Grid</button>
</div>

<script>
  var grid = document.getElementById("grid");
  var timerElement = document.getElementById("timer");
  var timerStarted = false;
  var startTime, timerInterval;
  var testMode = false;

  function generateGrid() {
    grid.innerHTML = "";
    clearInterval(timerInterval);
    timerElement.textContent = "0";
    timerStarted = false;
    for (var i = 0; i < 10; i++) {
      var row = grid.insertRow(i);
      for (var j = 0; j < 10; j++) {
        var cell = row.insertCell(j);
        cell.onclick = function () { handleFirstClick(this); };
        var mine = document.createAttribute("data-mine");
        mine.value = "false";
        cell.setAttributeNode(mine);
      }
    }
    addMines();
  }

  function addMines() {
    for (var i = 0; i < 20; i++) {
      var row = Math.floor(Math.random() * 10);
      var col = Math.floor(Math.random() * 10);
      var cell = grid.rows[row].cells[col];
      cell.setAttribute("data-mine", "true");
      if (testMode) cell.innerHTML = "X";
    }
  }

  function revealMines() {
    for (var i = 0; i < 10; i++) {
      for (var j = 0; j < 10; j++) {
        var cell = grid.rows[i].cells[j];
        if (cell.getAttribute("data-mine") == "true") cell.className = "mine";
      }
    }
  }



  function checkLevelCompletion() {
    let levelComplete = true;
    for (let i = 0; i < 10; i++) {
        for (let j = 0; j < 10; j++) {
            let cell = grid.rows[i].cells[j];
            if (cell.getAttribute("data-mine") === "false" && cell.innerHTML === "") {
                levelComplete = false;
            }
        }
    }

    if (levelComplete) {
        clearInterval(timerInterval);
        let finalSweepScore = parseInt(timerElement.textContent); // store the final time after winnign     ------ change back to parseInt(timerElement.textContent); after testing

        alert(`You Win in ${finalSweepScore} seconds!`);
        revealMines();

        // API call to save the score
        const userId = localStorage.getItem("uid"); // Get UID from local storage
        const gameName = "minesweeper"; // Set game name
        const lowerIsBetter = true; // Lower score is better set to true

        // Ensure userId exists before making the request
        if (!userId) {
            console.error("You are not signed in");
            return;
        }

        saveGameScore(userId, gameName, finalSweepScore, lowerIsBetter);
    }
}

// Function to send score to API
function saveGameScore(uid, game, score, lowerIsBetter) {
    fetch("https://fyp-60ev.onrender.com/update-score", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uid, game, score, lowerIsBetter }), // Sends score to backend
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Error saving score:", data.error);
        } else {
            console.log("Score saved successfully:", data);
        }
    })
    .catch(error => {
        console.error("Network error:", error);
    });
}



  function handleFirstClick(cell) {
    if (!timerStarted) {
      timerStarted = true;
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }
    clickCell(cell);
  }

  function clickCell(cell) {
    if (cell.getAttribute("data-mine") == "true") {
      revealMines();
      clearInterval(timerInterval);
      alert("Game Over");
    } else {
      cell.className = "clicked";
      var mineCount = 0;
      var cellRow = cell.parentNode.rowIndex;
      var cellCol = cell.cellIndex;
      for (var i = Math.max(cellRow - 1, 0); i <= Math.min(cellRow + 1, 9); i++) {
        for (var j = Math.max(cellCol - 1, 0); j <= Math.min(cellCol + 1, 9); j++) {
          if (grid.rows[i].cells[j].getAttribute("data-mine") == "true") mineCount++;
        }
      }
      cell.innerHTML = mineCount;
      if (mineCount == 0) {
        for (var i = Math.max(cellRow - 1, 0); i <= Math.min(cellRow + 1, 9); i++) {
          for (var j = Math.max(cellCol - 1, 0); j <= Math.min(cellCol + 1, 9); j++) {
            if (grid.rows[i].cells[j].innerHTML == "") clickCell(grid.rows[i].cells[j]);
          }
        }
      }
      checkLevelCompletion();
    }
  }

  function updateTimer() {
    var elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerElement.textContent = elapsed;
  }

  generateGrid();
</script>

</body>
</html>
